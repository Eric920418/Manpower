/**
 * RBAC æ¬Šé™é…ç½®ç³»çµ±
 * ä¸‰ç´šæ¬Šé™ï¼šè¶…ç´šç®¡ç†å“¡ > æ¥­ä¸» > æ¥­å‹™äººå“¡
 */

import { Role } from '@prisma/client';

/**
 * æ¬Šé™å‹•ä½œé¡å‹ - ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡
 */
export type Permission =
  // ç”¨æˆ¶ç®¡ç†
  | 'user:create'
  | 'user:read'
  | 'user:update'
  | 'user:delete'
  | 'user:manage_roles'
  // å…§å®¹ç®¡ç†
  | 'content:create'
  | 'content:read'
  | 'content:update'
  | 'content:delete'
  | 'content:publish'
  // é é¢ç®¡ç†
  | 'page:create'
  | 'page:read'
  | 'page:update'
  | 'page:delete'
  | 'page:publish'
  // å°èˆªç®¡ç†
  | 'nav:create'
  | 'nav:read'
  | 'nav:update'
  | 'nav:delete'
  // è¡¨å–®ç®¡ç†
  | 'form:create'
  | 'form:read'
  | 'form:update'
  | 'form:delete'
  | 'form:process'
  | 'form:export'
  // åˆç´„ç®¡ç†
  | 'contract:create'
  | 'contract:read'
  | 'contract:update'
  | 'contract:delete'
  | 'contract:sign'
  | 'contract:approve'
  // æª”æ¡ˆç®¡ç†
  | 'file:upload'
  | 'file:read'
  | 'file:delete'
  // ç³»çµ±è¨­å®š
  | 'system:config'
  | 'system:logs'
  | 'system:analytics'
  // å„€è¡¨æ¿
  | 'dashboard:view'
  | 'dashboard:stats';

/**
 * æ¬Šé™å¸¸é‡ - ä¾›ä»£ç¢¼ä¸­ä½¿ç”¨
 */
export const Permission = {
  // ç”¨æˆ¶ç®¡ç†
  USER_CREATE: 'user:create' as Permission,
  USER_READ: 'user:read' as Permission,
  USER_UPDATE: 'user:update' as Permission,
  USER_DELETE: 'user:delete' as Permission,
  USER_MANAGE_ROLES: 'user:manage_roles' as Permission,
  // å…§å®¹ç®¡ç†
  CONTENT_CREATE: 'content:create' as Permission,
  CONTENT_READ: 'content:read' as Permission,
  CONTENT_UPDATE: 'content:update' as Permission,
  CONTENT_DELETE: 'content:delete' as Permission,
  CONTENT_PUBLISH: 'content:publish' as Permission,
  // é é¢ç®¡ç†
  PAGE_CREATE: 'page:create' as Permission,
  PAGE_READ: 'page:read' as Permission,
  PAGE_UPDATE: 'page:update' as Permission,
  PAGE_DELETE: 'page:delete' as Permission,
  PAGE_PUBLISH: 'page:publish' as Permission,
  // å°èˆªç®¡ç†
  NAV_CREATE: 'nav:create' as Permission,
  NAV_READ: 'nav:read' as Permission,
  NAV_UPDATE: 'nav:update' as Permission,
  NAV_DELETE: 'nav:delete' as Permission,
  // è¡¨å–®ç®¡ç†
  FORM_CREATE: 'form:create' as Permission,
  FORM_READ: 'form:read' as Permission,
  FORM_UPDATE: 'form:update' as Permission,
  FORM_DELETE: 'form:delete' as Permission,
  FORM_PROCESS: 'form:process' as Permission,
  FORM_EXPORT: 'form:export' as Permission,
  // åˆç´„ç®¡ç†
  CONTRACT_CREATE: 'contract:create' as Permission,
  CONTRACT_READ: 'contract:read' as Permission,
  CONTRACT_UPDATE: 'contract:update' as Permission,
  CONTRACT_DELETE: 'contract:delete' as Permission,
  CONTRACT_SIGN: 'contract:sign' as Permission,
  CONTRACT_APPROVE: 'contract:approve' as Permission,
  // æª”æ¡ˆç®¡ç†
  FILE_UPLOAD: 'file:upload' as Permission,
  FILE_READ: 'file:read' as Permission,
  FILE_DELETE: 'file:delete' as Permission,
  // ç³»çµ±è¨­å®š
  SYSTEM_CONFIG: 'system:config' as Permission,
  SYSTEM_LOGS: 'system:logs' as Permission,
  SYSTEM_ANALYTICS: 'system:analytics' as Permission,
  // å„€è¡¨æ¿
  DASHBOARD_VIEW: 'dashboard:view' as Permission,
  DASHBOARD_STATS: 'dashboard:stats' as Permission,
};

/**
 * è§’è‰²æ¬Šé™æ˜ å°„è¡¨
 */
export const RolePermissions: Record<Role, Permission[]> = {
  /**
   * è¶…ç´šç®¡ç†å“¡ - æ“æœ‰æ‰€æœ‰æ¬Šé™
   */
  SUPER_ADMIN: [
    // ç”¨æˆ¶ç®¡ç†
    'user:create',
    'user:read',
    'user:update',
    'user:delete',
    'user:manage_roles',
    // å…§å®¹ç®¡ç†
    'content:create',
    'content:read',
    'content:update',
    'content:delete',
    'content:publish',
    // é é¢ç®¡ç†
    'page:create',
    'page:read',
    'page:update',
    'page:delete',
    'page:publish',
    // å°èˆªç®¡ç†
    'nav:create',
    'nav:read',
    'nav:update',
    'nav:delete',
    // è¡¨å–®ç®¡ç†
    'form:create',
    'form:read',
    'form:update',
    'form:delete',
    'form:process',
    'form:export',
    // åˆç´„ç®¡ç†
    'contract:create',
    'contract:read',
    'contract:update',
    'contract:delete',
    'contract:sign',
    'contract:approve',
    // æª”æ¡ˆç®¡ç†
    'file:upload',
    'file:read',
    'file:delete',
    // ç³»çµ±è¨­å®š
    'system:config',
    'system:logs',
    'system:analytics',
    // å„€è¡¨æ¿
    'dashboard:view',
    'dashboard:stats',
  ],

  /**
   * æ¥­ä¸» - å…¬å¸ç¶“ç‡Ÿè€…
   * å¯ä»¥ï¼š
   * - ç®¡ç†æ‰€æœ‰å…§å®¹å’Œé é¢
   * - æŸ¥çœ‹æ‰€æœ‰è¡¨å–®å’Œåˆç´„
   * - æŸ¥çœ‹ç³»çµ±åˆ†æå’Œæ—¥èªŒ
   * - ç®¡ç†ä¸€èˆ¬ç”¨æˆ¶ï¼ˆä¸èƒ½ç®¡ç†è¶…ç´šç®¡ç†å“¡ï¼‰
   * ä¸å¯ä»¥ï¼š
   * - ä¿®æ”¹ç³»çµ±æ ¸å¿ƒè¨­å®š
   * - åˆªé™¤ç”¨æˆ¶
   */
  OWNER: [
    // ç”¨æˆ¶ç®¡ç†ï¼ˆå—é™ï¼‰
    'user:read',
    'user:create',
    'user:update',

    // å…§å®¹ç®¡ç†ï¼ˆå®Œæ•´ï¼‰
    'content:create',
    'content:read',
    'content:update',
    'content:delete',
    'content:publish',

    // é é¢ç®¡ç†ï¼ˆå®Œæ•´ï¼‰
    'page:create',
    'page:read',
    'page:update',
    'page:delete',
    'page:publish',

    // å°èˆªç®¡ç†ï¼ˆå®Œæ•´ï¼‰
    'nav:create',
    'nav:read',
    'nav:update',
    'nav:delete',

    // è¡¨å–®ç®¡ç†ï¼ˆå®Œæ•´ï¼‰
    'form:create',
    'form:read',
    'form:update',
    'form:delete',
    'form:process',
    'form:export',

    // åˆç´„ç®¡ç†ï¼ˆå®Œæ•´ï¼‰
    'contract:create',
    'contract:read',
    'contract:update',
    'contract:delete',
    'contract:sign',
    'contract:approve',

    // æª”æ¡ˆç®¡ç†ï¼ˆå®Œæ•´ï¼‰
    'file:upload',
    'file:read',
    'file:delete',

    // ç³»çµ±åŠŸèƒ½ï¼ˆåƒ…æŸ¥çœ‹ï¼‰
    'system:logs',
    'system:analytics',

    // å„€è¡¨æ¿ï¼ˆå®Œæ•´ï¼‰
    'dashboard:view',
    'dashboard:stats',
  ],

  /**
   * æ¥­å‹™äººå“¡ - ä¸€èˆ¬å“¡å·¥
   * å¯ä»¥ï¼š
   * - æŸ¥çœ‹å’Œè™•ç†è¡¨å–®
   * - æŸ¥çœ‹åˆç´„ï¼ˆåƒ…è‡ªå·±ç›¸é—œï¼‰
   * - ä¸Šå‚³æª”æ¡ˆ
   * - æŸ¥çœ‹åŸºæœ¬å„€è¡¨æ¿
   * ä¸å¯ä»¥ï¼š
   * - ç®¡ç†ç”¨æˆ¶
   * - åˆªé™¤ä»»ä½•è³‡æ–™
   * - ä¿®æ”¹ç³»çµ±è¨­å®š
   */
  STAFF: [
    // ç”¨æˆ¶ç®¡ç†ï¼ˆåƒ…æŸ¥çœ‹è‡ªå·±ï¼‰
    'user:read',

    // å…§å®¹ç®¡ç†ï¼ˆåƒ…æŸ¥çœ‹ï¼‰
    'content:read',

    // é é¢ç®¡ç†ï¼ˆåƒ…æŸ¥çœ‹ï¼‰
    'page:read',

    // å°èˆªç®¡ç†ï¼ˆåƒ…æŸ¥çœ‹ï¼‰
    'nav:read',

    // è¡¨å–®ç®¡ç†ï¼ˆå—é™ï¼‰
    'form:read',
    'form:process',

    // åˆç´„ç®¡ç†ï¼ˆå—é™ï¼‰
    'contract:read',
    'contract:sign',

    // æª”æ¡ˆç®¡ç†ï¼ˆå—é™ï¼‰
    'file:upload',
    'file:read',

    // å„€è¡¨æ¿ï¼ˆåŸºæœ¬ï¼‰
    'dashboard:view',
  ],
};

/**
 * æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ“æœ‰ç‰¹å®šæ¬Šé™
 */
export function hasPermission(userRole: Role, permission: Permission): boolean {
  const permissions = RolePermissions[userRole];
  const result = permissions.includes(permission);

  // è©³ç´°æ—¥èªŒ - åˆ—å‡ºæ‰€æœ‰ file ç›¸é—œæ¬Šé™
  const filePermissions = permissions.filter(p => p.includes('file') || p.includes('FILE'));
  console.log('ğŸ” hasPermission è©³ç´°æª¢æŸ¥:', {
    userRole,
    permission,
    æŸ¥æ‰¾çš„æ¬Šé™: permission,
    é™£åˆ—å‰5é …: permissions.slice(0, 5),
    é™£åˆ—é•·åº¦: permissions.length,
    æª”æ¡ˆç›¸é—œæ¬Šé™: filePermissions,
    æ˜¯å¦åŒ…å«: result,
    ç›´æ¥æ¯”å°file_read: permissions.includes('file:read'),
  });

  return result;
}

/**
 * æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ“æœ‰ä»»ä¸€æ¬Šé™
 */
export function hasAnyPermission(
  userRole: Role,
  permissions: Permission[]
): boolean {
  return permissions.some((permission) => hasPermission(userRole, permission));
}

/**
 * æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ“æœ‰æ‰€æœ‰æ¬Šé™
 */
export function hasAllPermissions(
  userRole: Role,
  permissions: Permission[]
): boolean {
  return permissions.every((permission) => hasPermission(userRole, permission));
}

/**
 * ç²å–è§’è‰²çš„æ‰€æœ‰æ¬Šé™
 */
export function getRolePermissions(role: Role): Permission[] {
  return RolePermissions[role];
}

/**
 * æª¢æŸ¥è§’è‰²å±¤ç´šï¼ˆç”¨æ–¼åˆ¤æ–·æ˜¯å¦å¯ä»¥ç®¡ç†å…¶ä»–ç”¨æˆ¶ï¼‰
 */
export function canManageRole(managerRole: Role, targetRole: Role): boolean {
  const roleHierarchy: Record<Role, number> = {
    SUPER_ADMIN: 3,
    OWNER: 2,
    STAFF: 1,
  };

  return roleHierarchy[managerRole] > roleHierarchy[targetRole];
}

/**
 * æ¬Šé™èªªæ˜ï¼ˆç”¨æ–¼å¾Œå°é¡¯ç¤ºï¼‰
 */
export const RoleDescriptions: Record<Role, string> = {
  SUPER_ADMIN: 'ç³»çµ±æœ€é«˜æ¬Šé™ï¼Œå¯åŸ·è¡Œæ‰€æœ‰æ“ä½œï¼ŒåŒ…æ‹¬ç³»çµ±è¨­å®šå’Œç”¨æˆ¶ç®¡ç†',
  OWNER: 'å…¬å¸ç¶“ç‡Ÿè€…æ¬Šé™ï¼Œå¯ç®¡ç†å…§å®¹ã€è¡¨å–®ã€åˆç´„ï¼Œä½†ä¸èƒ½ä¿®æ”¹ç³»çµ±æ ¸å¿ƒè¨­å®š',
  STAFF: 'ä¸€èˆ¬å“¡å·¥æ¬Šé™ï¼Œå¯è™•ç†è¡¨å–®å’Œç°½ç½²åˆç´„ï¼Œåƒ…æœ‰æŸ¥çœ‹æ¬Šé™',
};

/**
 * ç²å–è§’è‰²çš„ä¸­æ–‡åç¨±
 */
export const RoleNames: Record<Role, string> = {
  SUPER_ADMIN: 'è¶…ç´šç®¡ç†å“¡',
  OWNER: 'æ¥­ä¸»',
  STAFF: 'æ¥­å‹™äººå“¡',
};
