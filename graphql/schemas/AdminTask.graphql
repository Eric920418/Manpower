# ==================== 行政事務簽核 ====================

# 行政任務狀態
enum AdminTaskStatus {
  PENDING              # 待處理
  PENDING_DOCUMENTS    # 待補件
  PENDING_REVIEW       # 待複審
  REVISION_REQUESTED   # 要求修改
  APPROVED             # 已批准
  REJECTED             # 已退回
  COMPLETED            # 已完成
  REVIEWED             # 已複審
}

# 審批路線
enum ApprovalRoute {
  V_ROUTE    # V 路線（主要審批）
  DASH_ROUTE # - 路線（次要審批）
}

# 簡化的用戶資訊
type TaskUser {
  id: ID!
  name: String
  email: String!
  role: String!
}

# 備註編輯記錄
type RemarkRecord {
  userId: String!
  userName: String!
  content: String!
  timestamp: String!
}

# 行政任務附件
type AdminTaskAttachment {
  id: ID!
  filename: String!
  originalName: String!
  mimeType: String!
  size: Int!
  path: String!
  url: String
  uploadedBy: String
  createdAt: String!
}

# 審批記錄
type ApprovalRecord {
  id: ID!
  taskId: Int!
  action: String!
  comment: String
  # 要求修改專用欄位
  revisionReason: String      # 修改原因類別
  revisionDetail: String      # 具體修改說明
  revisionDeadline: String    # 修改期限
  approver: TaskUser!
  createdAt: String!
}

# 行政任務
type AdminTask {
  id: ID!
  taskNo: String!
  taskType: TaskType!
  title: String!

  # 任務關聯（用於流程串接）
  parentTaskId: Int           # 父任務 ID
  parentTask: AdminTask       # 父任務關聯
  childTasks: [AdminTask!]!   # 子任務列表
  groupId: String             # 案件群組 ID（同群組任務會一起顯示）

  # 關聯人員
  applicant: TaskUser!
  applicantName: String
  processor: TaskUser
  processorName: String
  approver: TaskUser

  # 時間資訊
  applicationDate: String!
  deadline: String
  receivedAt: String
  completedAt: String

  # 狀態與路線
  status: AdminTaskStatus!
  approvalRoute: ApprovalRoute!
  approvalMark: String

  # 動態表單資料
  payload: JSON!

  # 複審確認
  reviewedAt: String          # 複審確認時間
  reviewedBy: String          # 複審確認人 ID

  # 細節（任務創建時填寫）
  notes: String

  # 備註（負責人/複審人後續添加）
  remarks: String
  remarksHistory: [RemarkRecord!]!  # 備註編輯記錄

  # 附件
  attachments: [AdminTaskAttachment!]!

  # 審批記錄
  approvalRecords: [ApprovalRecord!]!

  # 案件分配
  assignments: [AdminTaskAssignment!]!
  handlers: [TaskUser!]!    # 負責人列表
  reviewers: [TaskUser!]!   # 複審人列表

  createdAt: String!
  updatedAt: String!
}

# 分頁資訊
type AdminTaskPageInfo {
  total: Int!
  page: Int!
  pageSize: Int!
  totalPages: Int!
}

# 分頁的行政任務列表
type AdminTaskConnection {
  items: [AdminTask!]!
  pageInfo: AdminTaskPageInfo!
}

# 統計資訊
type AdminTaskStats {
  total: Int!
  pending: Int!
  pendingDocuments: Int!
  pendingReview: Int!
  revisionRequested: Int!
  approved: Int!
  rejected: Int!
  completed: Int!
  reviewed: Int!
  overdue: Int!
}

# 按類型統計
type TaskTypeStats {
  taskType: TaskType!
  count: Int!
  completed: Int!
  pending: Int!
}

# ==================== Queries ====================

extend type Query {
  # 獲取行政任務列表（分頁）
  adminTasks(
    page: Int
    pageSize: Int
    status: String  # 支援 AdminTaskStatus 枚舉值及特殊篩選值如 AWAITING_REVIEW_CHECK, OVERDUE
    taskTypeId: Int
    applicantId: String
    processorId: String
    approverId: String
    handlerId: String     # 按負責人篩選
    search: String
    sortBy: String
    sortOrder: String
    groupId: String       # 按群組篩選
    includeGrouped: Boolean  # 是否包含分組顯示（預設 true）
  ): AdminTaskConnection!

  # 獲取單個行政任務
  adminTask(id: Int!): AdminTask

  # 獲取行政任務統計
  adminTaskStats: AdminTaskStats!

  # 按類型統計
  adminTaskStatsByType: [TaskTypeStats!]!

  # 獲取待審批的任務（給 SUPER_ADMIN）
  pendingApprovalTasks(page: Int, pageSize: Int): AdminTaskConnection!

  # 獲取我的任務
  myAdminTasks(
    role: String  # applicant, processor, approver
    status: AdminTaskStatus
    page: Int
    pageSize: Int
  ): AdminTaskConnection!

  # 檢查待修改的案件（申請人收到要求修改通知）
  checkRevisionRequests: [RevisionRequestNotification!]!

  # 檢查待補件的任務
  checkPendingDocuments: [PendingDocumentNotification!]!

  # 檢查待處理的任務（分配給當前用戶但尚未處理）
  checkPendingTasks: [PendingTaskNotification!]!
}

# 待修改案件通知
type RevisionRequestNotification {
  taskId: Int!
  taskNo: String!
  title: String!
  revisionReason: String
  revisionDetail: String
  revisionDeadline: String
  requestedBy: TaskUser!
  requestedAt: String!
}

# 待補件通知
type PendingDocumentNotification {
  taskId: Int!
  taskNo: String!
  title: String!
  taskTypeName: String!
  pendingReason: String
  createdAt: String!
  updatedAt: String!
}

# 待處理任務通知
type PendingTaskNotification {
  taskId: Int!
  taskNo: String!
  title: String!
  taskTypeName: String!
  applicantName: String
  deadline: String
  createdAt: String!
}

# ==================== Inputs ====================

# 建檔表單 payload
input CreateFilePayload {
  employerName: String!           # 雇主名稱
  sourceType: String!             # 國內承接 or 國外引進
  workerName: String              # 移工姓名
  workerNationality: String       # 移工國籍
  workerPassportNo: String        # 護照號碼
  contractStartDate: String       # 合約開始日期
  contractEndDate: String         # 合約結束日期
  jobCategory: String             # 工作類別
  remarks: String                 # 備註
}

# 廢聘表單 payload
input TerminationPayload {
  employerName: String!           # 雇主名稱
  workerName: String!             # 移工姓名
  workerNationality: String       # 移工國籍
  terminationType: String!        # 廢聘類型（合意終止/期滿離境/逃跑/其他）
  terminationDate: String!        # 廢聘日期
  terminationReason: String       # 廢聘原因
  handoverStatus: String          # 交接狀態
  remarks: String                 # 備註
}

# 長照求才表單 payload
input LongTermCarePayload {
  employerName: String!           # 雇主/機構名稱
  employerType: String!           # 雇主類型（個人/機構）
  careType: String!               # 照護類型（居家照護/機構照護）
  patientInfo: String             # 被照護者資訊
  requiredSkills: [String!]       # 所需技能
  workLocation: String!           # 工作地點
  salaryRange: String             # 薪資範圍
  quantity: Int                   # 需求人數
  urgency: String                 # 緊急程度
  remarks: String                 # 備註
}

# 退補件表單 payload
input ReturnSupplementPayload {
  employerName: String!           # 雇主名稱
  workerName: String              # 移工姓名
  documentType: String!           # 文件類型
  returnReason: String!           # 退件原因
  supplementItems: [String!]      # 需補件項目
  originalSubmissionDate: String  # 原提交日期
  deadline: String                # 補件期限
  remarks: String                 # 備註
}

# 申請招募函表單 payload
input RecruitmentLetterPayload {
  employerName: String!           # 雇主名稱
  employerAddress: String         # 雇主地址
  jobCategory: String!            # 工作類別
  quantity: Int!                  # 招募人數
  nationality: [String!]          # 希望國籍
  salaryRange: String             # 薪資範圍
  workDescription: String         # 工作內容
  requirements: String            # 資格要求
  remarks: String                 # 備註
}

# 其他類型表單 payload（通用）
input OtherPayload {
  description: String!            # 事項描述
  details: String                 # 詳細說明
  relatedParties: [String!]       # 相關方
  remarks: String                 # 備註
}

# 創建行政任務輸入
input CreateAdminTaskInput {
  taskTypeId: Int!
  title: String!
  applicantName: String
  processorName: String
  deadline: String
  approvalRoute: ApprovalRoute
  payload: JSON!
  notes: String
  parentTaskId: Int    # 父任務 ID（關聯任務時使用）
  groupId: String      # 群組 ID（自動生成或繼承）
}

# 更新行政任務輸入
input UpdateAdminTaskInput {
  id: Int!
  title: String
  taskTypeId: Int
  applicantName: String
  processorName: String
  deadline: String
  processorId: String
  approverId: String
  approvalRoute: ApprovalRoute
  payload: JSON
  notes: String
}

# 審批操作輸入
input ApprovalInput {
  taskId: Int!
  action: String!  # approve, reject, pending_documents, request_revision
  comment: String
  # 要求修改專用欄位
  revisionReason: String      # 修改原因類別
  revisionDetail: String      # 具體修改說明
  revisionDeadline: String    # 修改期限 (ISO 日期字串)
}

# 更新任務狀態輸入
input UpdateTaskStatusInput {
  taskId: Int!
  status: AdminTaskStatus!
  notes: String
}

# 複審輸入
input ReviewTaskInput {
  taskId: Int!
  action: String!  # approve (通過), reject (駁回)
  comment: String
}

# 重新送出輸入（申請人修改後重新提交）
input ResubmitTaskInput {
  taskId: Int!
  payload: JSON       # 更新的表單資料
  notes: String       # 備註說明
}

# ==================== Mutations ====================

extend type Mutation {
  # 創建行政任務
  createAdminTask(input: CreateAdminTaskInput!): AdminTask!

  # 更新行政任務
  updateAdminTask(input: UpdateAdminTaskInput!): AdminTask!

  # 刪除行政任務
  deleteAdminTask(id: Int!): Boolean!

  # 審批操作
  approveTask(input: ApprovalInput!): AdminTask!

  # 更新任務狀態（完成人更新）
  updateTaskStatus(input: UpdateTaskStatusInput!): AdminTask!

  # 分配完成人
  assignProcessor(taskId: Int!, processorId: String!): AdminTask!

  # 分配審批人
  assignApprover(taskId: Int!, approverId: String!): AdminTask!

  # 上傳附件
  uploadTaskAttachment(taskId: Int!, file: JSON!): AdminTaskAttachment!

  # 刪除附件
  deleteTaskAttachment(attachmentId: Int!): Boolean!

  # 提交複審（負責人完成處理後提交給複審人）
  submitForReview(taskId: Int!, notes: String): AdminTask!

  # 複審操作（複審人審核案件）
  reviewTask(input: ReviewTaskInput!): AdminTask!

  # 重新送出案件（申請人修改後重新提交）
  resubmitTask(input: ResubmitTaskInput!): AdminTask!

  # 完成確認打勾（只有負責人可操作，將已批准改為已完成）
  toggleCompleteCheck(taskId: Int!, checked: Boolean!): AdminTask!

  # 複審確認打勾（只有複審人可操作）
  toggleReviewCheck(taskId: Int!, checked: Boolean!): AdminTask!

  # 更新任務備註（負責人或複審人可操作，複審後不可編輯）
  updateTaskRemarks(taskId: Int!, remarks: String!): AdminTask!
}
