# 用戶角色枚舉
enum Role {
  SUPER_ADMIN  # 超級管理員 - 系統最高權限
  ADMIN        # 管理員 - 可處理被分配的任務類型
  OWNER        # 業主
  STAFF        # 業務人員
}

# 用戶類型
type User {
  id: ID!
  email: String!
  name: String
  role: Role!
  department: String
  phone: String
  avatar: String
  isActive: Boolean!
  lastLoginAt: String
  invitationCode: String      # 邀請碼（SUPER_ADMIN 除外）
  invitationCount: Int!       # 成功邀請次數
  # 業務人員展示欄位
  position: String
  bio: String
  specialties: JSON
  lineId: String
  isPublic: Boolean!
  # 自訂權限設定
  customPermissions: UserCustomPermissions
  createdAt: String!
  updatedAt: String!
}

# 用戶自訂權限
type UserCustomPermissions {
  granted: [String!]!   # 額外授予的權限
  denied: [String!]!    # 禁止的權限
}

# 權限定義（用於前端顯示）
type PermissionDefinition {
  key: String!          # 權限代碼
  label: String!        # 顯示名稱
  description: String!  # 權限說明
  category: String!     # 分類
}

# 權限分類
type PermissionCategory {
  key: String!
  label: String!
  permissions: [PermissionDefinition!]!
}

# 用戶列表返回類型
type UserListResponse {
  users: [User!]!
  total: Int!
  page: Int!
  pageSize: Int!
  totalPages: Int!
}

# 用戶查詢輸入
input UserFilterInput {
  search: String
  role: Role
  isActive: Boolean
  department: String
}

# 用戶創建輸入
input CreateUserInput {
  email: String!
  name: String!
  password: String!
  role: Role!
  department: String
  phone: String
  isActive: Boolean
}

# 用戶更新輸入
input UpdateUserInput {
  email: String
  name: String
  password: String
  role: Role
  department: String
  phone: String
  avatar: String
  isActive: Boolean
  # 業務人員展示欄位
  position: String
  bio: String
  specialties: JSON
  lineId: String
  isPublic: Boolean
}

# 邀請碼驗證結果
type InvitationCodeValidation {
  valid: Boolean!
  userId: String
  userName: String
  message: String
}

# 業務人員簡易資訊（公開 API 用）
type StaffInfo {
  id: ID!
  name: String!
}

# 業務人員完整資訊（公開展示頁面用）
type StaffMember {
  id: ID!
  name: String!
  position: String
  avatar: String
  phone: String
  email: String!
  lineId: String
  bio: String
  specialties: JSON
  department: String
}

# 用戶查詢
extend type Query {
  # 獲取所有用戶（分頁）
  users(page: Int, pageSize: Int, filter: UserFilterInput): UserListResponse!

  # 獲取單個用戶
  user(id: ID!): User

  # 獲取當前登入用戶
  me: User

  # 驗證邀請碼
  validateInvitationCode(code: String!): InvitationCodeValidation!

  # 獲取所有業務人員列表（公開 API，用於表單選擇介紹人）
  staffList: [StaffInfo!]!

  # 獲取所有公開業務人員完整資訊（公開展示頁面用）
  staffMembers: [StaffMember!]!

  # 獲取所有可用權限列表（僅 SUPER_ADMIN）
  availablePermissions: [PermissionCategory!]!

  # 獲取用戶的有效權限（考慮角色權限 + 自訂權限）
  userEffectivePermissions(userId: ID!): [String!]!
}

# 自訂權限輸入
input UpdateUserPermissionsInput {
  granted: [String!]!   # 額外授予的權限
  denied: [String!]!    # 禁止的權限
}

# 用戶操作
extend type Mutation {
  # 創建用戶
  createUser(input: CreateUserInput!): User!

  # 更新用戶
  updateUser(id: ID!, input: UpdateUserInput!): User!

  # 刪除用戶
  deleteUser(id: ID!): Boolean!

  # 啟用/停用用戶
  toggleUserStatus(id: ID!): User!

  # 重置密碼
  resetUserPassword(id: ID!, newPassword: String!): Boolean!

  # 更新用戶權限（僅 SUPER_ADMIN）
  updateUserPermissions(userId: ID!, input: UpdateUserPermissionsInput!): User!
}
