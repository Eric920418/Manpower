generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 內容管理 ====================
// 彈性內容區塊（保留原有架構）
model ContentBlock {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  payload   Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 頁面管理
model Page {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  title       String
  description String?
  template    String    @default("default") // default, service, news
  content     Json      @default("[]") // 頁面區塊內容
  metaTags    Json?     // SEO meta tags
  status      String    @default("draft") // draft, published, archived
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?

  @@index([status, publishedAt])
}

// 導航選單
model Navigation {
  id       Int      @id @default(autoincrement())
  label    String
  url      String?
  parentId Int?
  order    Int      @default(0)
  isActive Boolean  @default(true)
  icon     String?
  target   String   @default("_self") // _self, _blank

  parent   Navigation?  @relation("NavigationHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Navigation[] @relation("NavigationHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, order])
}

// ==================== 加盟店管理 ====================
model Franchise {
  id          Int       @id @default(autoincrement())
  name        String    // 加盟店名稱
  code        String    @unique // 加盟店代碼（唯一識別碼）
  address     String?   // 地址
  phone       String?   // 電話
  email       String?   // Email
  description String?   @db.Text // 描述
  isActive    Boolean   @default(true)

  // 關聯
  users             User[]            @relation("FranchiseUsers")
  manpowerRequests  ManpowerRequest[] @relation("FranchiseRequests")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
}

// ==================== 用戶與權限 ====================
enum Role {
  SUPER_ADMIN  // 超級管理員 - 系統最高權限，可管理所有功能
  ADMIN        // 管理員 - 可處理被分配的任務類型
  OWNER        // 業主 - 公司經營者權限
  STAFF        // 業務人員 - 一般員工權限
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  password     String?   // 加密後的密碼
  role         Role      @default(STAFF)
  department   String?
  phone        String?
  avatar       String?
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  // 加盟店關聯（OWNER 和 STAFF 所屬的加盟店）
  franchiseId  Int?
  franchise    Franchise? @relation("FranchiseUsers", fields: [franchiseId], references: [id])

  // 業務人員展示欄位
  position     String?   // 職稱（如：業務經理、資深業務專員）
  bio          String?   @db.Text // 自我介紹
  specialties  Json?     // 專長領域（JSON 陣列）
  lineId       String?   // Line ID
  isPublic     Boolean   @default(true) // 是否在公開頁面顯示

  // 邀請碼系統
  invitationCode    String?   @unique // 自己的邀請碼（SUPER_ADMIN 除外）
  invitationCount   Int       @default(0) // 成功邀請次數

  // 自訂權限設定（僅 SUPER_ADMIN 可設定）
  // 格式：{ "granted": ["permission1", "permission2"], "denied": ["permission3"] }
  // granted: 額外授予的權限（即使角色沒有）
  // denied: 禁止的權限（即使角色有）
  customPermissions Json?

  // 關聯 - 活動日誌
  activityLogs    ActivityLog[]

  // 關聯 - 人力需求
  invitedRequests ManpowerRequest[] @relation("InvitedBy") // 透過邀請碼帶來的需求

  // 關聯 - 行政事務簽核
  appliedTasks      AdminTask[]      @relation("TaskApplicant")   // 我申請的任務
  processedTasks    AdminTask[]      @relation("TaskProcessor")   // 我處理的任務
  approvedTasks     AdminTask[]      @relation("TaskApprover")    // 我審批的任務
  approvalRecords   ApprovalRecord[] @relation("ApprovalActor")   // 我的審批記錄

  // 關聯 - 案件分配
  taskAssignments       AdminTaskAssignment[] @relation("TaskAssignments")
  taskAssignmentsGiven  AdminTaskAssignment[] @relation("TaskAssigner")

  // 關聯 - 全局分配設定
  taskTypeDefaultAssignments        TaskTypeDefaultAssignment[] @relation("TaskTypeDefaultAssignments")
  taskTypeDefaultAssignmentsCreated TaskTypeDefaultAssignment[] @relation("TaskTypeDefaultAssignmentCreator")

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([role, isActive])
  @@index([invitationCode])
  @@index([franchiseId, role])
}

// 活動日誌
model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    String
  action    String   // login, logout, create, update, delete
  entity    String   // user, admin_task, page
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?

  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([entity, entityId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
}

// ==================== 系統設定 ====================
model SystemConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  category  String   @default("general") // general, email, sms, payment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}

// ==================== 人力需求管理 ====================
model ManpowerRequest {
  id                    Int       @id @default(autoincrement())
  requestNo             String    @unique // 需求單號（自動生成）
  selectedResumeIds     Json      // 選中的履歷 IDs（JSON 陣列）

  // 聯絡資訊
  companyName           String?  // 選填
  contactPerson         String   // 必填
  contactPhone          String
  contactEmail          String?  // 選填
  lineId                String?  // Line ID（選填）

  // 申請資格（複選）
  qualifications        Json?    // 選中的申請資格 IDs（JSON 陣列）

  // 職位需求（改為全部可選，企業可稍後補充）
  positionTitle         String?
  jobDescription        String?   @db.Text
  quantity              Int       @default(1) // 需要人數
  salaryRange           String?   // 例如：30000-40000
  expectedStartDate     DateTime? // 預計到職日期
  workLocation          String?   // 工作地點

  // 其他資訊
  additionalRequirements String?  @db.Text
  status                String    @default("pending") // pending, processing, completed, rejected, cancelled

  // 邀請碼系統
  invitationCode        String?   // 客戶填寫的邀請碼
  invitedBy             String?   // 邀請人 userId
  inviter               User?     @relation("InvitedBy", fields: [invitedBy], references: [id])

  // 加盟店關聯（記錄需求單屬於哪個加盟店，用於資料隔離）
  franchiseId           Int?
  franchise             Franchise? @relation("FranchiseRequests", fields: [franchiseId], references: [id])

  // 處理資訊
  notes                 String?   @db.Text // 管理員處理備註
  processedBy           String?
  processedAt           DateTime?

  // 系統資訊
  ipAddress             String?
  userAgent             String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([status, createdAt(sort: Desc)])
  @@index([contactEmail])
  @@index([requestNo])
  @@index([processedBy, status])
  @@index([invitedBy, createdAt(sort: Desc)])
  @@index([status, processedAt(sort: Desc)])
  @@index([invitedBy, status, createdAt(sort: Desc)])
  @@index([franchiseId, status, createdAt(sort: Desc)])
}

// ==================== 行政事務簽核 ====================

// 行政任務類型（可動態管理）
model TaskType {
  id          Int         @id @default(autoincrement())
  code        String      @unique  // 類型代碼（如 CREATE_FILE）
  label       String               // 顯示名稱（如 建檔）
  description String?              // 描述
  order       Int         @default(0)  // 排序
  isActive    Boolean     @default(true) // 是否啟用
  // 自訂問題設定（JSON 陣列）
  // 格式：[{ id, label, type, options?, required?, trigger?: { answer, taskTypeId } }]
  questions   Json        @default("[]")
  // 任務標題 placeholder（用於新增行政任務時的輸入提示）
  titlePlaceholder String?
  // 節點位置（用於流程圖顯示）
  positionX   Float?      // X 座標
  positionY   Float?      // Y 座標
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 關聯
  tasks          AdminTask[]
  // 流程關聯
  outgoingFlows  TaskTypeFlow[] @relation("FlowFrom")  // 從此類型出發的流程
  incomingFlows  TaskTypeFlow[] @relation("FlowTo")    // 到達此類型的流程
  // 全局分配設定
  defaultAssignments TaskTypeDefaultAssignment[]

  @@index([isActive, order])
}

// 全局分配設定（依案件類型自動分配管理員）
model TaskTypeDefaultAssignment {
  id          Int            @id @default(autoincrement())
  taskTypeId  Int            // 案件類型 ID
  userId      String         // 被分配的管理員 ID
  role        AssignmentRole @default(HANDLER)  // 分配角色：負責人或複審人
  createdAt   DateTime       @default(now())
  createdBy   String?        // 設定者 ID

  // 關聯
  taskType    TaskType       @relation(fields: [taskTypeId], references: [id], onDelete: Cascade)
  user        User           @relation("TaskTypeDefaultAssignments", fields: [userId], references: [id], onDelete: Cascade)
  creator     User?          @relation("TaskTypeDefaultAssignmentCreator", fields: [createdBy], references: [id])

  @@unique([taskTypeId, userId, role])  // 同一用戶在同一類型中同一角色只能有一個分配
  @@index([taskTypeId])
  @@index([userId])
  @@index([role])
}

// 任務類型流程關聯（支援多重後續、線性和分支流程）
model TaskTypeFlow {
  id              Int       @id @default(autoincrement())
  fromTaskTypeId  Int       // 來源任務類型
  toTaskTypeId    Int       // 目標任務類型
  label           String?   // 連線標籤（如：「是」「否」）
  // 條件設定（JSON）
  // 格式：{ questionId?: string, answer?: string } 或 null（無條件/固定流程）
  condition       Json?
  order           Int       @default(0)  // 排序（同一來源的多個目標）
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 關聯
  fromTaskType    TaskType  @relation("FlowFrom", fields: [fromTaskTypeId], references: [id], onDelete: Cascade)
  toTaskType      TaskType  @relation("FlowTo", fields: [toTaskTypeId], references: [id], onDelete: Cascade)

  @@unique([fromTaskTypeId, toTaskTypeId, condition])  // 防止重複的流程連線
  @@index([fromTaskTypeId])
  @@index([toTaskTypeId])
}

// 行政任務狀態
enum AdminTaskStatus {
  PENDING              // 待處理
  PENDING_DOCUMENTS    // 待補件
  PENDING_REVIEW       // 待複審
  REVISION_REQUESTED   // 要求修改
  APPROVED             // 已批准
  REJECTED             // 已退回
  COMPLETED            // 已完成
  REVIEWED             // 已複審
}

// 分配角色
enum AssignmentRole {
  HANDLER   // 負責人（處理案件）
  REVIEWER  // 複審人（審核案件）
}

// 審批路線
enum ApprovalRoute {
  V_ROUTE    // V 路線（主要審批）
  DASH_ROUTE // - 路線（次要審批）
}

// 行政任務
model AdminTask {
  id              Int              @id @default(autoincrement())
  taskNo          String           @unique // 任務編號（自動生成，格式：AT-YYYYMMDD-XXXX）
  taskTypeId      Int              // 任務類型 ID
  taskType        TaskType         @relation(fields: [taskTypeId], references: [id])
  title           String           // 任務標題

  // 任務關聯（用於流程串接）
  parentTaskId    Int?             // 父任務 ID（由哪個任務觸發產生）
  parentTask      AdminTask?       @relation("TaskRelation", fields: [parentTaskId], references: [id])
  childTasks      AdminTask[]      @relation("TaskRelation")
  groupId         String?          // 案件群組 ID（同一群組的任務會一起顯示）

  // 關聯人員
  applicantId     String           // 申請人 ID（系統登入用戶）
  applicant       User             @relation("TaskApplicant", fields: [applicantId], references: [id])
  applicantName   String?          // 自訂申請人名稱（可覆蓋系統用戶名稱）
  processorId     String?          // 完成人/經辦人 ID（系統用戶）
  processor       User?            @relation("TaskProcessor", fields: [processorId], references: [id])
  processorName   String?          // 自訂完成人名稱
  approverId      String?          // 主管檢核 ID
  approver        User?            @relation("TaskApprover", fields: [approverId], references: [id])

  // 時間資訊
  applicationDate DateTime         @default(now()) // 申請日期
  deadline        DateTime?        // 完成限期
  receivedAt      DateTime?        // 受理日期時間
  completedAt     DateTime?        // 完成時間

  // 狀態與路線
  status          AdminTaskStatus  @default(PENDING)
  approvalRoute   ApprovalRoute    @default(V_ROUTE)
  approvalMark    String?          // 主管檢核標記 (V 或 -)

  // 動態表單資料（根據 taskType 不同結構）
  payload         Json             @default("{}")

  // 複審確認（由複審人打勾確認）
  reviewedAt      DateTime?        // 複審確認時間
  reviewedBy      String?          // 複審確認人 ID

  // 細節（任務創建時填寫）
  notes           String?          @db.Text
  notesHistory    Json             @default("[]")  // 細節編輯記錄 [{userId, userName, content, timestamp}]

  // 備註（負責人/複審人後續添加，複審後凍結）
  remarks         String?          @db.Text
  remarksHistory  Json             @default("[]")  // 備註編輯記錄 [{userId, userName, content, timestamp}]

  // 基本資訊編輯記錄（記錄標題、完成限期等變更）
  basicInfoHistory Json            @default("[]")  // 基本資訊編輯記錄 [{userId, userName, changes: {field, oldValue, newValue}[], timestamp}]

  // 附件
  attachments     AdminTaskAttachment[]

  // 審批記錄
  approvalRecords ApprovalRecord[]

  // 案件分配（新機制）
  assignments     AdminTaskAssignment[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([taskTypeId, status, applicationDate(sort: Desc)])
  @@index([applicantId, status])
  @@index([processorId, status])
  @@index([approverId, status])
  @@index([taskNo])
  @@index([status, deadline])
  @@index([status, applicationDate(sort: Desc)])
  @@index([parentTaskId])
  @@index([groupId])
}

// 案件分配（多對多關聯表）
model AdminTaskAssignment {
  id          Int            @id @default(autoincrement())
  taskId      Int            // 案件 ID
  userId      String         // 被分配的用戶 ID
  role        AssignmentRole @default(HANDLER)  // 分配角色：負責人或複審人
  assignedAt  DateTime       @default(now())  // 分配時間
  assignedBy  String?        // 分配者（SUPER_ADMIN）ID
  notes       String?        // 分配備註

  // 關聯
  task        AdminTask      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User           @relation("TaskAssignments", fields: [userId], references: [id], onDelete: Cascade)
  assigner    User?          @relation("TaskAssigner", fields: [assignedBy], references: [id])

  @@unique([taskId, userId, role])  // 同一用戶在同一案件中同一角色只能有一個分配
  @@index([taskId])
  @@index([userId])
  @@index([role])
}

// 審批記錄
model ApprovalRecord {
  id          Int              @id @default(autoincrement())
  taskId      Int
  task        AdminTask        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  action      String           // approve, reject, request_revision, add_signer, pending_documents
  comment     String?          @db.Text

  // 要求修改專用欄位
  revisionReason   String?     // 修改原因類別
  revisionDetail   String?     @db.Text // 具體修改說明
  revisionDeadline DateTime?   // 修改期限

  approverId  String
  approver    User             @relation("ApprovalActor", fields: [approverId], references: [id])

  createdAt   DateTime         @default(now())

  @@index([taskId, createdAt(sort: Desc)])
  @@index([approverId])
}

// 行政任務附件
model AdminTaskAttachment {
  id            Int       @id @default(autoincrement())
  taskId        Int
  task          AdminTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  filename      String
  originalName  String
  mimeType      String
  size          Int       // 檔案大小（bytes）
  path          String    // 儲存路徑
  url           String?   // 公開訪問 URL

  uploadedBy    String?
  createdAt     DateTime  @default(now())

  @@index([taskId])
  @@index([taskId, createdAt(sort: Desc)])
}

// ==================== 待處理任務提醒 ====================
// 用於追蹤用戶選擇「稍後處理」的關聯任務提醒
model PendingTaskReminder {
  id              Int       @id @default(autoincrement())
  userId          String    // 需要被提醒的用戶 ID
  sourceTaskId    Int       // 觸發提醒的原始任務 ID
  taskTypeId      Int       // 建議創建的任務類型 ID
  taskTypeLabel   String    // 任務類型名稱（快取，避免查詢）
  isCompleted     Boolean   @default(false) // 是否已完成（創建了對應任務）
  completedTaskId Int?      // 完成時創建的任務 ID
  lastRemindedAt  DateTime? // 上次提醒時間
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, isCompleted])
  @@index([userId, isCompleted, lastRemindedAt])
  @@index([sourceTaskId])
}

// ==================== 聯絡表單提交 ====================
model ContactSubmission {
  id            Int       @id @default(autoincrement())
  questionType  String    // 問題類型 ID
  questionLabel String?   // 問題類型顯示名稱（快取）
  name          String    // 姓名
  email         String    // 電子信箱
  phone         String    // 聯絡電話
  message       String    @db.Text // 訊息內容
  status        String    @default("pending") // pending, read, replied, archived
  notes         String?   @db.Text // 管理員備註
  repliedAt     DateTime? // 回覆時間
  repliedBy     String?   // 回覆人員 ID
  ipAddress     String?   // IP 地址
  userAgent     String?   // 瀏覽器資訊
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status, createdAt(sort: Desc)])
  @@index([questionType, status])
  @@index([email])
  @@index([createdAt(sort: Desc)])
}

// ==================== 分析與報表 ====================
model Analytics {
  id          Int      @id @default(autoincrement())
  event       String   // page_view, form_submit, task_created
  category    String   // traffic, conversion, engagement
  action      String?
  label       String?
  value       Float?
  userId      String?
  sessionId   String?
  ipAddress   String?
  userAgent   String?
  referrer    String?
  data        Json?    // 額外數據

  createdAt   DateTime @default(now())

  @@index([event, createdAt])
  @@index([category, createdAt])
  @@index([userId, createdAt])
  @@index([event, userId, createdAt(sort: Desc)])
  @@index([category, event, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}
