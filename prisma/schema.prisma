generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 內容管理 ====================
// 彈性內容區塊（保留原有架構）
model ContentBlock {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  payload   Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 頁面管理
model Page {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  title       String
  description String?
  template    String    @default("default") // default, service, news
  content     Json      @default("[]") // 頁面區塊內容
  metaTags    Json?     // SEO meta tags
  status      String    @default("draft") // draft, published, archived
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?

  @@index([status, publishedAt])
}

// 導航選單
model Navigation {
  id       Int      @id @default(autoincrement())
  label    String
  url      String?
  parentId Int?
  order    Int      @default(0)
  isActive Boolean  @default(true)
  icon     String?
  target   String   @default("_self") // _self, _blank

  parent   Navigation?  @relation("NavigationHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Navigation[] @relation("NavigationHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, order])
}

// ==================== 用戶與權限 ====================
enum Role {
  SUPER_ADMIN  // 超級管理員 - 系統最高權限
  OWNER        // 業主 - 公司經營者權限
  STAFF        // 業務人員 - 一般員工權限
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  password     String?   // 加密後的密碼
  role         Role      @default(STAFF)
  department   String?
  phone        String?
  avatar       String?
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  // 業務人員展示欄位
  position     String?   // 職稱（如：業務經理、資深業務專員）
  bio          String?   @db.Text // 自我介紹
  specialties  Json?     // 專長領域（JSON 陣列）
  lineId       String?   // Line ID
  isPublic     Boolean   @default(true) // 是否在公開頁面顯示

  // 邀請碼系統
  invitationCode    String?   @unique // 自己的邀請碼（SUPER_ADMIN 除外）
  invitationCount   Int       @default(0) // 成功邀請次數

  // 關聯 - 活動日誌
  activityLogs    ActivityLog[]

  // 關聯 - 人力需求
  invitedRequests ManpowerRequest[] @relation("InvitedBy") // 透過邀請碼帶來的需求

  // 關聯 - 行政事務簽核
  appliedTasks      AdminTask[]      @relation("TaskApplicant")   // 我申請的任務
  processedTasks    AdminTask[]      @relation("TaskProcessor")   // 我處理的任務
  approvedTasks     AdminTask[]      @relation("TaskApprover")    // 我審批的任務
  approvalRecords   ApprovalRecord[] @relation("ApprovalActor")   // 我的審批記錄

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([role, isActive])
  @@index([invitationCode])
}

// 活動日誌
model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    String
  action    String   // login, logout, create, update, delete
  entity    String   // user, admin_task, page
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?

  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([entity, entityId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
}

// ==================== 系統設定 ====================
model SystemConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  category  String   @default("general") // general, email, sms, payment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}

// ==================== 人力需求管理 ====================
model ManpowerRequest {
  id                    Int       @id @default(autoincrement())
  requestNo             String    @unique // 需求單號（自動生成）
  selectedResumeIds     Json      // 選中的履歷 IDs（JSON 陣列）

  // 聯絡資訊
  companyName           String?  // 選填
  contactPerson         String   // 必填
  contactPhone          String
  contactEmail          String?  // 選填
  lineId                String?  // Line ID（選填）

  // 申請資格（複選）
  qualifications        Json?    // 選中的申請資格 IDs（JSON 陣列）

  // 職位需求（改為全部可選，企業可稍後補充）
  positionTitle         String?
  jobDescription        String?   @db.Text
  quantity              Int       @default(1) // 需要人數
  salaryRange           String?   // 例如：30000-40000
  expectedStartDate     DateTime? // 預計到職日期
  workLocation          String?   // 工作地點

  // 其他資訊
  additionalRequirements String?  @db.Text
  status                String    @default("pending") // pending, processing, completed, rejected, cancelled

  // 邀請碼系統
  invitationCode        String?   // 客戶填寫的邀請碼
  invitedBy             String?   // 邀請人 userId
  inviter               User?     @relation("InvitedBy", fields: [invitedBy], references: [id])

  // 處理資訊
  notes                 String?   @db.Text // 管理員處理備註
  processedBy           String?
  processedAt           DateTime?

  // 系統資訊
  ipAddress             String?
  userAgent             String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([status, createdAt(sort: Desc)])
  @@index([contactEmail])
  @@index([requestNo])
  @@index([processedBy, status])
  @@index([invitedBy, createdAt(sort: Desc)])
  @@index([status, processedAt(sort: Desc)])
  @@index([invitedBy, status, createdAt(sort: Desc)])
}

// ==================== 行政事務簽核 ====================

// 行政任務類型（可動態管理）
model TaskType {
  id          Int         @id @default(autoincrement())
  code        String      @unique  // 類型代碼（如 CREATE_FILE）
  label       String               // 顯示名稱（如 建檔）
  description String?              // 描述
  order       Int         @default(0)  // 排序
  isActive    Boolean     @default(true) // 是否啟用
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 關聯
  tasks       AdminTask[]

  @@index([isActive, order])
}

// 行政任務狀態
enum AdminTaskStatus {
  PENDING     // 待處理
  PROCESSING  // 處理中
  APPROVED    // 已批准
  REJECTED    // 已退回
  COMPLETED   // 已完成
}

// 審批路線
enum ApprovalRoute {
  V_ROUTE    // V 路線（主要審批）
  DASH_ROUTE // - 路線（次要審批）
}

// 行政任務
model AdminTask {
  id              Int              @id @default(autoincrement())
  taskNo          String           @unique // 任務編號（自動生成，格式：AT-YYYYMMDD-XXXX）
  taskTypeId      Int              // 任務類型 ID
  taskType        TaskType         @relation(fields: [taskTypeId], references: [id])
  title           String           // 任務標題

  // 關聯人員
  applicantId     String           // 申請人 ID（系統登入用戶）
  applicant       User             @relation("TaskApplicant", fields: [applicantId], references: [id])
  applicantName   String?          // 自訂申請人名稱（可覆蓋系統用戶名稱）
  processorId     String?          // 完成人/經辦人 ID（系統用戶）
  processor       User?            @relation("TaskProcessor", fields: [processorId], references: [id])
  processorName   String?          // 自訂完成人名稱
  approverId      String?          // 主管檢核 ID
  approver        User?            @relation("TaskApprover", fields: [approverId], references: [id])

  // 時間資訊
  applicationDate DateTime         @default(now()) // 申請日期
  deadline        DateTime?        // 完成限期
  receivedAt      DateTime?        // 受理日期時間
  completedAt     DateTime?        // 完成時間

  // 狀態與路線
  status          AdminTaskStatus  @default(PENDING)
  approvalRoute   ApprovalRoute    @default(V_ROUTE)
  approvalMark    String?          // 主管檢核標記 (V 或 -)

  // 動態表單資料（根據 taskType 不同結構）
  payload         Json             @default("{}")

  // 備註
  notes           String?          @db.Text

  // 附件
  attachments     AdminTaskAttachment[]

  // 審批記錄
  approvalRecords ApprovalRecord[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([taskTypeId, status, applicationDate(sort: Desc)])
  @@index([applicantId, status])
  @@index([processorId, status])
  @@index([approverId, status])
  @@index([taskNo])
  @@index([status, deadline])
  @@index([status, applicationDate(sort: Desc)])
}

// 審批記錄
model ApprovalRecord {
  id          Int              @id @default(autoincrement())
  taskId      Int
  task        AdminTask        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  action      String           // approve, reject, request_revision, add_signer
  comment     String?          @db.Text

  approverId  String
  approver    User             @relation("ApprovalActor", fields: [approverId], references: [id])

  createdAt   DateTime         @default(now())

  @@index([taskId, createdAt(sort: Desc)])
  @@index([approverId])
}

// 行政任務附件
model AdminTaskAttachment {
  id            Int       @id @default(autoincrement())
  taskId        Int
  task          AdminTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  filename      String
  originalName  String
  mimeType      String
  size          Int       // 檔案大小（bytes）
  path          String    // 儲存路徑
  url           String?   // 公開訪問 URL

  uploadedBy    String?
  createdAt     DateTime  @default(now())

  @@index([taskId])
  @@index([taskId, createdAt(sort: Desc)])
}

// ==================== 分析與報表 ====================
model Analytics {
  id          Int      @id @default(autoincrement())
  event       String   // page_view, form_submit, task_created
  category    String   // traffic, conversion, engagement
  action      String?
  label       String?
  value       Float?
  userId      String?
  sessionId   String?
  ipAddress   String?
  userAgent   String?
  referrer    String?
  data        Json?    // 額外數據

  createdAt   DateTime @default(now())

  @@index([event, createdAt])
  @@index([category, createdAt])
  @@index([userId, createdAt])
  @@index([event, userId, createdAt(sort: Desc)])
  @@index([category, event, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}
