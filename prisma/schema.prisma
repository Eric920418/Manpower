generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== å…§å®¹ç®¡ç† ====================
// å½ˆæ€§å…§å®¹å€å¡Šï¼ˆä¿ç•™åŸæœ‰æ¶æ§‹ï¼‰
model ContentBlock {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  payload   Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// é é¢ç®¡ç†
model Page {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  title       String
  description String?
  template    String    @default("default") // default, service, news
  content     Json      @default("[]") // é é¢å€å¡Šå…§å®¹
  metaTags    Json?     // SEO meta tags
  status      String    @default("draft") // draft, published, archived
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?

  @@index([status, publishedAt])
}

// å°èˆªé¸å–®
model Navigation {
  id       Int      @id @default(autoincrement())
  label    String
  url      String?
  parentId Int?
  order    Int      @default(0)
  isActive Boolean  @default(true)
  icon     String?
  target   String   @default("_self") // _self, _blank

  parent   Navigation?  @relation("NavigationHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Navigation[] @relation("NavigationHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, order])
}

// ==================== ç”¨æˆ¶èˆ‡æ¬Šé™ ====================
enum Role {
  SUPER_ADMIN  // è¶…ç´šç®¡ç†å“¡ - ç³»çµ±æœ€é«˜æ¬Šé™
  OWNER        // æ¥­ä¸» - å…¬å¸ç¶“ç‡Ÿè€…æ¬Šé™
  STAFF        // æ¥­å‹™äººå“¡ - ä¸€èˆ¬å“¡å·¥æ¬Šé™
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  password     String?   // åŠ å¯†å¾Œçš„å¯†ç¢¼
  role         Role      @default(STAFF)
  department   String?
  phone        String?
  avatar       String?
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  // æ¥­å‹™äººå“¡å±•ç¤ºæ¬„ä½
  position     String?   // è·ç¨±ï¼ˆå¦‚ï¼šæ¥­å‹™ç¶“ç†ã€è³‡æ·±æ¥­å‹™å°ˆå“¡ï¼‰
  bio          String?   @db.Text // è‡ªæˆ‘ä»‹ç´¹
  specialties  Json?     // å°ˆé•·é ˜åŸŸï¼ˆJSON é™£åˆ—ï¼‰
  lineId       String?   // Line ID
  isPublic     Boolean   @default(true) // æ˜¯å¦åœ¨å…¬é–‹é é¢é¡¯ç¤º

  // é‚€è«‹ç¢¼ç³»çµ±
  invitationCode    String?   @unique // è‡ªå·±çš„é‚€è«‹ç¢¼ï¼ˆSUPER_ADMIN é™¤å¤–ï¼‰
  invitationCount   Int       @default(0) // æˆåŠŸé‚€è«‹æ¬¡æ•¸

  // é—œè¯
  createdForms    FormSubmission[] @relation("FormCreator")
  processedForms  FormSubmission[] @relation("FormProcessor")
  contracts       Contract[]       @relation("ContractCreator")
  signatures      Signature[]
  activityLogs    ActivityLog[]
  invitedRequests ManpowerRequest[] @relation("InvitedBy") // é€éé‚€è«‹ç¢¼å¸¶ä¾†çš„éœ€æ±‚

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([role, isActive])
  @@index([invitationCode])
}

// æ´»å‹•æ—¥èªŒ
model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    String
  action    String   // login, logout, create, update, delete
  entity    String   // user, form, contract, page
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?

  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  // âœ… å„ªåŒ–ï¼šè¤‡åˆç´¢å¼•
  @@index([userId, createdAt(sort: Desc)]) // ç”¨æˆ¶æ´»å‹•æ­·å²
  @@index([entity, entityId, createdAt(sort: Desc)]) // å¯¦é«”æ“ä½œæ­·å²
  @@index([action, createdAt(sort: Desc)]) // æŒ‰æ“ä½œé¡å‹æŸ¥è©¢
}

// ==================== è¡¨å–®ç³»çµ± ====================
model FormTemplate {
  id          Int      @id @default(autoincrement())
  name        String
  type        String   // job, company, franchise, contact, custom
  description String?
  fields      Json     // è¡¨å–®æ¬„ä½å®šç¾©
  settings    Json?    // è¡¨å–®è¨­å®šï¼ˆé©—è­‰è¦å‰‡ã€é€šçŸ¥ç­‰ï¼‰
  isActive    Boolean  @default(true)

  submissions FormSubmission[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FormSubmission {
  id           Int           @id @default(autoincrement())
  templateId   Int
  formType     String        // job, company, franchise, contact, custom
  data         Json          // æäº¤çš„è¡¨å–®æ•¸æ“š
  status       String        @default("pending") // pending, processing, completed, rejected
  notes        String?       // è™•ç†å‚™è¨»

  // æäº¤è€…è³‡è¨Š
  submitterName  String?
  submitterEmail String?
  submitterPhone String?
  ipAddress      String?

  // è™•ç†è³‡è¨Š
  processedAt    DateTime?
  processedBy    String?

  // âœ… ä¿®å¾©ï¼šä½¿ç”¨ ID ä½œç‚ºå¤–éµè€Œé email
  createdById    String?      // å‰µå»ºè€… IDï¼ˆç™»å…¥ç”¨æˆ¶ï¼‰

  // é—œè¯
  template    FormTemplate @relation(fields: [templateId], references: [id])
  creator     User?        @relation("FormCreator", fields: [createdById], references: [id])
  processor   User?        @relation("FormProcessor", fields: [processedBy], references: [id])
  attachments Attachment[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // âœ… å„ªåŒ–ï¼šè¤‡åˆç´¢å¼•ï¼ˆå¸¸ä¸€èµ·æŸ¥è©¢çš„æ¬„ä½ï¼‰
  @@index([formType, status, createdAt(sort: Desc)]) // åˆ—è¡¨æŸ¥è©¢å„ªåŒ–
  @@index([submitterEmail(ops: raw("varchar_pattern_ops"))]) // æ¨¡ç³Šæœå°‹å„ªåŒ–
  @@index([createdById]) // å¤–éµç´¢å¼•
  @@index([processedBy]) // å¤–éµç´¢å¼•
  @@index([templateId]) // ğŸ†• å¤–éµç´¢å¼•ï¼Œç”¨æ–¼ include: { template: true }
  @@index([status, processedAt(sort: Desc)]) // ğŸ†• å·²è™•ç†æäº¤æŸ¥è©¢
  @@index([templateId, status, createdAt(sort: Desc)]) // ğŸ†• æŒ‰æ¨¡æ¿ç¯©é¸
}

// ==================== åˆç´„ç®¡ç† ====================
model ContractTemplate {
  id          Int        @id @default(autoincrement())
  name        String
  type        String     // employment, service, franchise
  content     String     // åˆç´„å…§å®¹æ¨¡æ¿ï¼ˆæ”¯æ´è®Šæ•¸ï¼‰
  variables   Json?      // å¯ç”¨è®Šæ•¸å®šç¾©
  isActive    Boolean    @default(true)

  contracts   Contract[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Contract {
  id           Int               @id @default(autoincrement())
  templateId   Int
  contractNo   String            @unique // åˆç´„ç·¨è™Ÿ
  title        String
  content      String            // æœ€çµ‚åˆç´„å…§å®¹
  parties      Json              // ç°½ç´„æ–¹è³‡è¨Š
  status       String            @default("draft") // draft, pending, signed, expired, terminated

  // æœ‰æ•ˆæœŸ
  validFrom    DateTime?
  validUntil   DateTime?

  // ç°½ç½²è³‡è¨Š
  signedAt     DateTime?

  // é—œè¯
  template     ContractTemplate  @relation(fields: [templateId], references: [id])
  createdBy    String
  creator      User              @relation("ContractCreator", fields: [createdBy], references: [id])
  signatures   Signature[]
  attachments  Attachment[]

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // âœ… å„ªåŒ–ï¼šè¤‡åˆç´¢å¼•
  @@index([status, validUntil]) // éæœŸåˆç´„æŸ¥è©¢
  @@index([contractNo]) // å”¯ä¸€ç·¨è™ŸæŸ¥è©¢
  @@index([createdBy, createdAt(sort: Desc)]) // ç”¨æˆ¶åˆç´„åˆ—è¡¨
  @@index([templateId]) // ğŸ†• å¤–éµç´¢å¼•ï¼Œç”¨æ–¼ include: { template: true }
  @@index([validFrom, validUntil]) // ğŸ†• æŸ¥è©¢æœ‰æ•ˆæœŸé–“çš„åˆç´„
  @@index([status]) // ğŸ†• æŒ‰ç‹€æ…‹ç¯©é¸åˆç´„
}

// é›»å­ç°½å
model Signature {
  id          Int      @id @default(autoincrement())
  contractId  Int
  userId      String
  signedName  String   // ç°½ç½²è€…å§“å
  signedAt    DateTime @default(now())
  ipAddress   String
  signature   String?  // Base64 ç·¨ç¢¼çš„ç°½ååœ–ç‰‡

  // OTP é©—è­‰
  otpCode     String?
  otpVerified Boolean  @default(false)

  contract    Contract @relation(fields: [contractId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@unique([contractId, userId])
  @@index([contractId])
}

// ==================== æª”æ¡ˆç®¡ç† ====================
model Attachment {
  id             Int             @id @default(autoincrement())
  filename       String
  originalName   String
  mimeType       String
  size           Int             // æª”æ¡ˆå¤§å°ï¼ˆbytesï¼‰
  path           String          // å„²å­˜è·¯å¾‘
  url            String?         // å…¬é–‹è¨ªå• URL

  // å¤šæ…‹é—œè¯ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
  formId         Int?
  contractId     Int?

  // é—œè¯
  form           FormSubmission? @relation(fields: [formId], references: [id], onDelete: Cascade)
  contract       Contract?       @relation(fields: [contractId], references: [id], onDelete: Cascade)

  uploadedBy     String?
  createdAt      DateTime        @default(now())

  @@index([formId])
  @@index([contractId])
  @@index([formId, createdAt(sort: Desc)]) // ğŸ†• è¡¨å–®é™„ä»¶åˆ—è¡¨
  @@index([contractId, createdAt(sort: Desc)]) // ğŸ†• åˆç´„é™„ä»¶åˆ—è¡¨
}

// ==================== ç³»çµ±è¨­å®š ====================
model SystemConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  category  String   @default("general") // general, email, sms, payment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}


// ==================== äººåŠ›éœ€æ±‚ç®¡ç† ====================
model ManpowerRequest {
  id                    Int       @id @default(autoincrement())
  requestNo             String    @unique // éœ€æ±‚å–®è™Ÿï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
  selectedResumeIds     Json      // é¸ä¸­çš„å±¥æ­· IDsï¼ˆJSON é™£åˆ—ï¼‰

  // è¯çµ¡è³‡è¨Š
  companyName           String?  // é¸å¡«
  contactPerson         String   // å¿…å¡«
  contactPhone          String
  contactEmail          String?  // é¸å¡«
  lineId                String?  // Line IDï¼ˆé¸å¡«ï¼‰

  // ç”³è«‹è³‡æ ¼ï¼ˆè¤‡é¸ï¼‰
  qualifications        Json?    // é¸ä¸­çš„ç”³è«‹è³‡æ ¼ IDsï¼ˆJSON é™£åˆ—ï¼‰

  // è·ä½éœ€æ±‚ï¼ˆæ”¹ç‚ºå…¨éƒ¨å¯é¸ï¼Œä¼æ¥­å¯ç¨å¾Œè£œå……ï¼‰
  positionTitle         String?
  jobDescription        String?   @db.Text
  quantity              Int       @default(1) // éœ€è¦äººæ•¸
  salaryRange           String?   // ä¾‹å¦‚ï¼š30000-40000
  expectedStartDate     DateTime? // é è¨ˆåˆ°è·æ—¥æœŸ
  workLocation          String?   // å·¥ä½œåœ°é»

  // å…¶ä»–è³‡è¨Š
  additionalRequirements String?  @db.Text
  status                String    @default("pending") // pending, processing, completed, rejected, cancelled

  // é‚€è«‹ç¢¼ç³»çµ±
  invitationCode        String?   // å®¢æˆ¶å¡«å¯«çš„é‚€è«‹ç¢¼
  invitedBy             String?   // é‚€è«‹äºº userId
  inviter               User?     @relation("InvitedBy", fields: [invitedBy], references: [id])

  // è™•ç†è³‡è¨Š
  notes                 String?   @db.Text // ç®¡ç†å“¡è™•ç†å‚™è¨»
  processedBy           String?
  processedAt           DateTime?

  // ç³»çµ±è³‡è¨Š
  ipAddress             String?
  userAgent             String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // âœ… å„ªåŒ–ï¼šè¤‡åˆç´¢å¼•
  @@index([status, createdAt(sort: Desc)]) // éœ€æ±‚åˆ—è¡¨ï¼ˆæŒ‰ç‹€æ…‹å’Œæ™‚é–“ï¼‰
  @@index([contactEmail]) // å®¢æˆ¶éœ€æ±‚æŸ¥è©¢
  @@index([requestNo]) // ç·¨è™ŸæŸ¥è©¢
  @@index([processedBy, status]) // è™•ç†äººå“¡å·¥ä½œåˆ—è¡¨
  @@index([invitedBy, createdAt(sort: Desc)]) // é‚€è«‹äººçš„å®¢æˆ¶åˆ—è¡¨
  @@index([status, processedAt(sort: Desc)]) // ğŸ†• å·²è™•ç†éœ€æ±‚æŸ¥è©¢
  @@index([invitedBy, status, createdAt(sort: Desc)]) // ğŸ†• æ¥­å‹™äººå“¡å·¥ä½œåˆ—è¡¨
}

// ==================== åˆ†æèˆ‡å ±è¡¨ ====================
model Analytics {
  id          Int      @id @default(autoincrement())
  event       String   // page_view, form_submit, contract_signed
  category    String   // traffic, conversion, engagement
  action      String?
  label       String?
  value       Float?
  userId      String?
  sessionId   String?
  ipAddress   String?
  userAgent   String?
  referrer    String?
  data        Json?    // é¡å¤–æ•¸æ“š

  createdAt   DateTime @default(now())

  @@index([event, createdAt])
  @@index([category, createdAt])
  @@index([userId, createdAt])
  @@index([event, userId, createdAt(sort: Desc)]) // ğŸ†• ç”¨æˆ¶äº‹ä»¶è·Ÿè¹¤
  @@index([category, event, createdAt(sort: Desc)]) // ğŸ†• åˆ†é¡çµ±è¨ˆ
  @@index([createdAt(sort: Desc)]) // ğŸ†• æœ€è¿‘äº‹ä»¶æ’åº
}